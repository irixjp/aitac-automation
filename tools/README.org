* 環境構築

** 最初に1回だけ実施

#+begin_src shell
  # VPCの設定
  ansible-playbook -i ec2_inventory ec2_vpc_prepare.yml

  # nginx リバースプロキシサーバーの起動, 初期設定, SSL証明書取得
  ansible-playbook -i ec2_inventory nginx_bootstrap.yml
  ansible-playbook -i nginx_inventory nginx_base_config.yml
  ansible-playbook -i nginx_inventory nginx_ssl.yml -e "admin_email=xxx@yyy.com" -e "server_fqdn=zzz.example.com"
#+end_src

** 講義ごとに実施

- class_id 4〜6文字程度の文字列を指定(20251207 とかでOK)
- instance_num 起動する演習環境数(インスタンス数)を指定 = 受講人数 + 3-5 程度

#+begin_src shell
  # インスタンス起動
  ansible-playbook -i ec2_inventory ec2_instance_create.yml -e "class_id=yyyymmdd" -e "instance_num=2"

  # 初期設定
  ansible-playbook -i yyyymmdd_podman_inventory podman_install.yml

  # 演習環境設定
  ansible-playbook -i yyyymmdd_podman_inventory podman_container_deploy.yml

  # 演習コンテンツの配布
  ansible-playbook -i yyyymmdd_podman_inventory distributing_contents.yml

  # リバースプロキシ設定
  ansible-playbook -i nginx_inventory -i yyyymmdd_class_env_info.txt nginx_class_config.yml -e "class_id=yyyymmdd"
#+end_src

** SSL証明書の更新

#+begin_src shell
  # 期限が30日を切っていると更新される
  ansible-playbook -i nginx_inventory nginx_ssl.yml -e "admin_email=xxx@yyy.com" -e "server_fqdn=zzz.example.com"
#+end_src


* 環境削除

** 講義が終了したら実施

#+begin_src shell
  # EC2 インスタンスの削除
  ansible-playbook -i ec2_inventory ec2_instance_delete.yml -e "class_id=xxyy"

  # リバースプロキシ設定の削除
  ansible-playbook -i nginx_inventory nginx_cleanup_class.yml -e "class_id=yyyymmdd"
#+end_src


* その他情報

起動しているインスタンスの確認
#+begin_src shell
  aws ec2 describe-instances --output=table --query 'Reservations[].Instances[].{InstanceId: InstanceId, PrivateIp: join(`, `, NetworkInterfaces[].PrivateIpAddress), GlobalIP: join(`, `, NetworkInterfaces[].Association.PublicIp), Platform:Platform, State: State.Name, SecurityGroupId: join(`, `, SecurityGroups[].GroupId) ,Name: Tags[?Key==`Name`].Value|[0]}'
#+end_src
